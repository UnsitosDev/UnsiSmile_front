<div class="p-4">
  <mat-card-title><strong>Indice de Higiene Oral Simplificado (IHOS)</strong></mat-card-title>
  <table class="w-full">
    <tr>
      <td>Diente</td>
      @for (toothPair of toothPairs; track $index) {
        <td>
          <mat-select [(ngModel)]="selectedValues[$index]" required class="no-focus-style">
            <mat-option [value]="toothPair[0]">{{ toothPair[0] }}</mat-option>
            <mat-option [value]="toothPair[1]">{{ toothPair[1] }}</mat-option>
          </mat-select>
        </td>
      }
    </tr>

    <tr>
      <td>Código</td>
      @for (toothNumber of selectedValues; track $index) {
        <td [contentEditable]="tableEditable"
            (input)="validateInput($event, toothNumber)"
            [textContent]="codes[toothNumber]">
        </td>
      }
    </tr>
  </table>

  <div class="mt-4 flex justify-start">
    <button mat-raised-button [hidden]="!showButtonIHOS" color="primary" (click)="store()">
      Guardar IHOS
    </button>
  </div>
</div>

<mat-divider></mat-divider>

<div class="p-4 flex justify-end">
  <button matbutton color="primary" (click)="openInsertProphylaxis()" class="button-custom">
    <strong>+</strong> Nueva sesión profilaxis
  </button>
</div>
<div class="space-y-8">
  @if (registerProfilaxis) {
    @for (record of registerProfilaxis.content; track record; let i = $index) {
      <div class="p-4">
        <mat-accordion>
          <mat-expansion-panel hideToggle>
            <mat-expansion-panel-header>
              <mat-panel-title>Sesión {{ registerProfilaxis.content.length - i }}</mat-panel-title>
              <mat-panel-description>Fecha: {{ formatDate(record.creationDate) }}</mat-panel-description>
              <span>Porcentaje: {{record.percentage}} %</span>
            </mat-expansion-panel-header>
            <!-- Contenedor principal (scroll en móvil, centrado en tablet/PC) -->
            <div class="overflow-x-auto md:overflow-x-visible md:flex md:justify-center">
              <!-- Contenedor de cuadrantes -->
              <div class="min-w-max md:min-w-0 space-y-4 md:w-auto">
                <!-- Fila superior -->
                <div class="flex gap-4 justify-center">
                  <!-- Cuadrante 1 (11-18) -->
                  <div class="p-2">
                    <div class="flex gap-[5px] justify-end">
                      @for (toothNumber of [18, 17, 16, 15, 14, 13, 12, 11]; track toothNumber) {
                        @if (findTooth(record.teethProphylaxis, toothNumber); as tooth) {
                          <div class="flex flex-col items-center min-w-[40px]">
                            @if (!hasCondition(tooth, 'Diente no presente')) {
                              <svg width="32" height="32" class="mt-1">
                                <rect width="32" height="32" fill="white" stroke="#333" stroke-width="1.5"/>

                                <!-- Cara 1 -->
                                <polygon
                                  points="0,0 16,16 0,32"
                                  [attr.fill]="isFaceMarked(tooth, '1') ? 'var(--prophylaxis)' : 'var(--white-color)'"
                                  stroke="#333"
                                  stroke-width="1.5"
                                />

                                <!-- Cara 2 -->
                                <polygon
                                  points="32,0 16,16 32,32"
                                  [attr.fill]="isFaceMarked(tooth, '2') ? 'var(--prophylaxis)' : 'var(--white-color)'"
                                  stroke="#333"
                                  stroke-width="1.5"
                                />

                                <!-- Cara 3 -->
                                <polygon
                                  points="0,32 16,16 32,32"
                                  [attr.fill]="isFaceMarked(tooth, '3') ? 'var(--prophylaxis)' : 'var(--white-color)'"
                                  stroke="#333"
                                  stroke-width="1.5"
                                />

                                <!-- Cara 4 -->
                                <polygon
                                  points="0,0 16,16 32,0"
                                  [attr.fill]="isFaceMarked(tooth, '4') ? 'var(--prophylaxis)' : 'var(--white-color)'"
                                  stroke="#333"
                                  stroke-width="1.5"
                                />

                                @if (hasCondition(tooth, 'Diente extraido')) {
                                  <polygon
                                    points="16,5 30,25 2,25"
                                    fill="white"
                                    stroke="#ef4444"
                                    stroke-width="1.5"
                                  />
                                }
                              </svg>


                            } @else {
                              <span class="text-[10px] mt-1">Ausente</span>
                            }
                            <span class="text-xs font-medium">{{ toothNumber }}</span>
                          </div>
                        } @else {
                          <!-- Diente sin datos (mostrar vacío) -->
                          <div class="flex flex-col items-center min-w-[40px]">
                            <svg width="32" height="32" class="mt-1">
                              <rect width="32" height="32" fill="white" stroke="#333" stroke-width="1.5"/>
                              <polygon
                                points="0,0 16,16 0,32"
                                [attr.fill]="'var(--white-color)'"
                                stroke="#333"
                                stroke-width="1.5"
                              />

                              <!-- Cara 2 -->
                              <polygon
                                points="32,0 16,16 32,32"
                                [attr.fill]="'var(--white-color)'"
                                stroke="#333"
                                stroke-width="1.5"
                              />

                              <!-- Cara 3 -->
                              <polygon
                                points="0,32 16,16 32,32"
                                [attr.fill]="'var(--white-color)'"
                                stroke="#333"
                                stroke-width="1.5"
                              />

                              <!-- Cara 4 -->
                              <polygon
                                points="0,0 16,16 32,0"
                                [attr.fill]="'var(--white-color)'"
                                stroke="#333"
                                stroke-width="1.5"
                              />
                            </svg>
                            <span class="text-xs font-medium text-gray-400">{{ toothNumber }}</span>
                          </div>
                        }
                      }
                    </div>
                  </div>

                  <!-- Cuadrante 2 (21-28) -->
                  <div class="p-2">
                    <div class="flex gap-[5px] justify-start">
                      @for (toothNumber of [21, 22, 23, 24, 25, 26, 27, 28]; track toothNumber) {
                        @if (findTooth(record.teethProphylaxis, toothNumber); as tooth) {
                          <div class="flex flex-col items-center min-w-[40px]">
                            @if (!hasCondition(tooth, 'Diente no presente')) {
                              <svg width="32" height="32" class="mt-1">
                                <rect width="32" height="32" fill="white" stroke="#333" stroke-width="1.5"/>

                                <!-- Cara 1 -->
                                <polygon
                                  points="0,0 16,16 0,32"
                                  [attr.fill]="isFaceMarked(tooth, '1') ? 'var(--prophylaxis)' : 'var(--white-color)'"
                                  stroke="#333"
                                  stroke-width="1.5"
                                />

                                <!-- Cara 2 -->
                                <polygon
                                  points="32,0 16,16 32,32"
                                  [attr.fill]="isFaceMarked(tooth, '2') ? 'var(--prophylaxis)' : 'var(--white-color)'"
                                  stroke="#333"
                                  stroke-width="1.5"
                                />

                                <!-- Cara 3 -->
                                <polygon
                                  points="0,32 16,16 32,32"
                                  [attr.fill]="isFaceMarked(tooth, '3') ? 'var(--prophylaxis)' : 'var(--white-color)'"
                                  stroke="#333"
                                  stroke-width="1.5"
                                />

                                <!-- Cara 4 -->
                                <polygon
                                  points="0,0 16,16 32,0"
                                  [attr.fill]="isFaceMarked(tooth, '4') ? 'var(--prophylaxis)' : 'var(--white-color)'"
                                  stroke="#333"
                                  stroke-width="1.5"
                                />

                                @if (hasCondition(tooth, 'Diente extraido')) {
                                  <polygon
                                    points="16,5 30,25 2,25"
                                    fill="white"
                                    stroke="#ef4444"
                                    stroke-width="1.5"
                                  />
                                }
                              </svg>
                            } @else {
                              <span class="text-[10px] mt-1">Ausente</span>
                            }
                            <span class="text-xs font-medium">{{ toothNumber }}</span>
                          </div>
                        } @else {
                          <!-- Diente sin datos -->
                          <div class="flex flex-col items-center min-w-[40px]">
                            <svg width="32" height="32" class="mt-1">
                              <rect width="32" height="32" fill="white" stroke="#333" stroke-width="1.5"/>
                              <polygon
                                points="0,0 16,16 0,32"
                                [attr.fill]="'var(--white-color)'"
                                stroke="#333"
                                stroke-width="1.5"
                              />

                              <!-- Cara 2 -->
                              <polygon
                                points="32,0 16,16 32,32"
                                [attr.fill]="'var(--white-color)'"
                                stroke="#333"
                                stroke-width="1.5"
                              />

                              <!-- Cara 3 -->
                              <polygon
                                points="0,32 16,16 32,32"
                                [attr.fill]="'var(--white-color)'"
                                stroke="#333"
                                stroke-width="1.5"
                              />

                              <!-- Cara 4 -->
                              <polygon
                                points="0,0 16,16 32,0"
                                [attr.fill]="'var(--white-color)'"
                                stroke="#333"
                                stroke-width="1.5"
                              />
                            </svg>
                            <span class="text-xs font-medium text-gray-400">{{ toothNumber }}</span>
                          </div>
                        }
                      }
                    </div>
                  </div>
                </div>

                <!-- Fila inferior (Cuadrantes 3 y 4) -->
                <div class="inline-flex gap-4">
                  <!-- Cuadrante 3 (31-38) -->
                  <div class="p-2">
                    <div class="flex gap-[5px] justify-end">
                      @for (toothNumber of [48, 47, 46, 45, 44, 43, 42, 41]; track toothNumber) {
                        @if (findTooth(record.teethProphylaxis, toothNumber); as tooth) {
                          <div class="flex flex-col items-center min-w-[40px]">
                            @if (!hasCondition(tooth, 'Diente no presente')) {
                              <svg width="32" height="32" class="mt-1">
                                <rect width="32" height="32" fill="white" stroke="#333" stroke-width="1.5"/>

                                <!-- Cara 1 -->
                                <polygon
                                  points="0,0 16,16 0,32"
                                  [attr.fill]="isFaceMarked(tooth, '1') ? 'var(--prophylaxis)' : 'var(--white-color)'"
                                  stroke="#333"
                                  stroke-width="1.5"
                                />

                                <!-- Cara 2 -->
                                <polygon
                                  points="32,0 16,16 32,32"
                                  [attr.fill]="isFaceMarked(tooth, '2') ? 'var(--prophylaxis)' : 'var(--white-color)'"
                                  stroke="#333"
                                  stroke-width="1.5"
                                />

                                <!-- Cara 3 -->
                                <polygon
                                  points="0,32 16,16 32,32"
                                  [attr.fill]="isFaceMarked(tooth, '3') ? 'var(--prophylaxis)' : 'var(--white-color)'"
                                  stroke="#333"
                                  stroke-width="1.5"
                                />

                                <!-- Cara 4 -->
                                <polygon
                                  points="0,0 16,16 32,0"
                                  [attr.fill]="isFaceMarked(tooth, '4') ? 'var(--prophylaxis)' : 'var(--white-color)'"
                                  stroke="#333"
                                  stroke-width="1.5"
                                />

                                @if (hasCondition(tooth, 'Diente extraido')) {
                                  <polygon
                                    points="16,5 30,25 2,25"
                                    fill="white"
                                    stroke="#ef4444"
                                    stroke-width="1.5"
                                  />
                                }
                              </svg>
                            } @else {
                              <span class="text-[10px] mt-1">Ausente</span>
                            }
                            <span class="text-xs font-medium">{{ toothNumber }}</span>
                          </div>
                        } @else {
                          <!-- Diente sin datos -->
                          <div class="flex flex-col items-center min-w-[40px]">
                            <svg width="32" height="32" class="mt-1">
                              <rect width="32" height="32" fill="white" stroke="#333" stroke-width="1.5"/>
                              <polygon
                                points="0,0 16,16 0,32"
                                [attr.fill]="'var(--white-color)'"
                                stroke="#333"
                                stroke-width="1.5"
                              />

                              <!-- Cara 2 -->
                              <polygon
                                points="32,0 16,16 32,32"
                                [attr.fill]="'var(--white-color)'"
                                stroke="#333"
                                stroke-width="1.5"
                              />

                              <!-- Cara 3 -->
                              <polygon
                                points="0,32 16,16 32,32"
                                [attr.fill]="'var(--white-color)'"
                                stroke="#333"
                                stroke-width="1.5"
                              />

                              <!-- Cara 4 -->
                              <polygon
                                points="0,0 16,16 32,0"
                                [attr.fill]="'var(--white-color)'"
                                stroke="#333"
                                stroke-width="1.5"
                              />
                            </svg>
                            <span class="text-xs font-medium text-gray-400">{{ toothNumber }}</span>
                          </div>
                        }
                      }
                    </div>
                  </div>

                  <!-- Cuadrante 4 (41-48) -->
                  <div class="p-2">
                    <div class="flex gap-[5px] justify-start">
                      @for (toothNumber of [31, 32, 33, 34, 35, 36, 37, 38]; track toothNumber) {
                        @if (findTooth(record.teethProphylaxis, toothNumber); as tooth) {
                          <div class="flex flex-col items-center min-w-[40px]">
                            @if (!hasCondition(tooth, 'Diente no presente')) {
                              <svg width="32" height="32" class="mt-1">
                                <rect width="32" height="32" fill="white" stroke="#333" stroke-width="1.5"/>

                                <!-- Cara 1 -->
                                <polygon
                                  points="0,0 16,16 0,32"
                                  [attr.fill]="isFaceMarked(tooth, '1') ? 'var(--prophylaxis)' : 'var(--white-color)'"
                                  stroke="#333"
                                  stroke-width="1.5"
                                />

                                <!-- Cara 2 -->
                                <polygon
                                  points="32,0 16,16 32,32"
                                  [attr.fill]="isFaceMarked(tooth, '2') ? 'var(--prophylaxis)' : 'var(--white-color)'"
                                  stroke="#333"
                                  stroke-width="1.5"
                                />

                                <!-- Cara 3 -->
                                <polygon
                                  points="0,32 16,16 32,32"
                                  [attr.fill]="isFaceMarked(tooth, '3') ? 'var(--prophylaxis)' : 'var(--white-color)'"
                                  stroke="#333"
                                  stroke-width="1.5"
                                />

                                <!-- Cara 4 -->
                                <polygon
                                  points="0,0 16,16 32,0"
                                  [attr.fill]="isFaceMarked(tooth, '4') ? 'var(--prophylaxis)' : 'var(--white-color)'"
                                  stroke="#333"
                                  stroke-width="1.5"
                                />

                                @if (hasCondition(tooth, 'Diente extraido')) {
                                  <polygon
                                    points="16,5 30,25 2,25"
                                    fill="white"
                                    stroke="#ef4444"
                                    stroke-width="1.5"
                                  />
                                }
                              </svg>
                            } @else {
                              <span class="text-[10px] mt-1">Ausente</span>
                            }
                            <span class="text-xs font-medium">{{ toothNumber }}</span>
                          </div>
                        } @else {
                          <!-- Diente sin datos -->
                          <div class="flex flex-col items-center min-w-[40px]">
                            <svg width="32" height="32" class="mt-1">
                              <rect width="32" height="32" fill="white" stroke="#333" stroke-width="1.5"/>
                              <polygon
                                points="0,0 16,16 0,32"
                                [attr.fill]="'var(--white-color)'"
                                stroke="#333"
                                stroke-width="1.5"
                              />

                              <!-- Cara 2 -->
                              <polygon
                                points="32,0 16,16 32,32"
                                [attr.fill]="'var(--white-color)'"
                                stroke="#333"
                                stroke-width="1.5"
                              />

                              <!-- Cara 3 -->
                              <polygon
                                points="0,32 16,16 32,32"
                                [attr.fill]="'var(--white-color)'"
                                stroke="#333"
                                stroke-width="1.5"
                              />

                              <!-- Cara 4 -->
                              <polygon
                                points="0,0 16,16 32,0"
                                [attr.fill]="'var(--white-color)'"
                                stroke="#333"
                                stroke-width="1.5"
                              />
                            </svg>
                            <span class="text-xs font-medium text-gray-400">{{ toothNumber }}</span>
                          </div>
                        }
                      }
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </mat-expansion-panel>
        </mat-accordion>
      </div>
    }
  }
</div>

@if (!isLastPage) {
  <div class="p-4 flex justify-center">
    <button mat-button color="primary" (click)="loadMore()" [disabled]="isLoading" class="button-custom">
      {{ isLoading ? 'Cargando...' : 'Cargar más' }}
    </button>
  </div>
}

<div class="grid-button p-4">
  <div></div>
  <div>
    <button type="button" (click)="nextTab()" mat-button>
      <span class="hidden sm:inline">Avanzar </span>
      <i class="fas fa-long-arrow-alt-right"></i>
    </button>
  </div>
</div>
