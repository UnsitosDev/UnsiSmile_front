<mat-card class="full-width-card">
  <mat-card-title><strong>Información del paciente</strong></mat-card-title>
</mat-card>

@if (isLoading) {
  <div class="loading-overlay">
    <app-loading></app-loading>
  </div>
}

@if (!isLoading) {
<mat-stepper class="fondo" linear #stepper>
  <mat-step>
    <form [formGroup]="formGroup">
      <ng-template matStepLabel>DATOS PERSONALES</ng-template>
      <div class="edit-button-container">
        <button type="button" class="btn" [class.btn-primary]="!isEditMode" [class.btn-warning]="isEditMode" (click)="toggleEditMode()">
          <i class="fas" [class.fa-edit]="!isEditMode" [class.fa-times]="isEditMode"></i>
          {{ isEditMode ? 'Cancelar edición' : 'Editar información' }}
        </button>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mt-6">
        @for (field of personal; track $index) {
          @if (shouldShowField(field)) {
            <app-field-component
              [field]="field"
              [formGroup]="formGroup"
              [errors]="field.errorMessages"
              (setFieldValue)="onFieldValueChange($event)"
              (ageStatusChange)="onAgeStatusChange($event)">
            </app-field-component>
          }
        }
      </div>
      <div class="button-container single">
        <button mat-flat-button color="primary" matStepperNext>Siguiente <i class="fas fa-long-arrow-alt-right"></i></button>
      </div>
    </form>
  </mat-step>

  <mat-step>
    <form [formGroup]="formGroup">
      <ng-template matStepLabel>DOMICILIO</ng-template>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mt-6" (scroll)="onScroll($event)">
        @for (field of address; track $index) {
          @if (shouldShowField(field)) {
            <app-field-component
              [field]="field"
              [formGroup]="formGroup"
              [errors]="field.errorMessages"
              (setFieldValue)="onFieldValueChange($event)">
            </app-field-component>
          }
        }
      </div>
      <div class="button-container">
        <button mat-flat-button color="primary" matStepperPrevious><i class="fas fa-long-arrow-alt-left"></i> Anterior</button>
        <button mat-flat-button color="primary" matStepperNext>Siguiente <i class="fas fa-long-arrow-alt-right"></i></button>
      </div>
    </form>
  </mat-step>

  <mat-step>
    <form [formGroup]="formGroup">
      <ng-template matStepLabel>OTROS DATOS</ng-template>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mt-6">
        @for (field of other; track $index) {
          @if (shouldShowField(field)) {
            <app-field-component
              [field]="field"
              [formGroup]="formGroup"
              [errors]="field.errorMessages"
              (setFieldValue)="onFieldValueChange($event)">
            </app-field-component>
          }
        }
      </div>
      <div class="button-container">
        <button mat-flat-button color="primary" matStepperPrevious>
          <i class="fas fa-long-arrow-alt-left"></i> Anterior
        </button>
        @if (minorPatient || (disabledPatient && needsGuardian)) {
          <button mat-flat-button color="primary" matStepperNext>
            Siguiente <i class="fas fa-long-arrow-alt-right"></i>
          </button>
        }
        @if (!minorPatient && !(disabledPatient && needsGuardian)) {
          <button mat-flat-button color="primary" (click)="onSubmit()">
            Guardar <i class="fas fa-save"></i>
          </button>
        }
      </div>
    </form>
  </mat-step>

  @if (minorPatient || (disabledPatient && needsGuardian)) {
    <mat-step >
      <form [formGroup]="formGroup">
        <ng-template matStepLabel>DATOS DEL TUTOR</ng-template>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mt-6">
          @for (field of guardian; track $index) {
            @if (shouldShowField(field)) {
              <app-field-component
                [field]="field"
                [formGroup]="formGroup"
                [errors]="field.errorMessages"
                (setFieldValue)="onFieldValueChange($event)">
              </app-field-component>
            }
          }
        </div>
        <div class="button-container">
          <button mat-flat-button color="primary" matStepperPrevious><i class="fas fa-long-arrow-alt-left"></i> Anterior</button>
          <button mat-flat-button color="primary" (click)="onSubmit()">Guardar <i class="fas fa-save"></i></button>
        </div>
      </form>
    </mat-step>
  }
</mat-stepper>
}

<app-alert></app-alert>


